<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Animación con Cesium – Día, Tarde y Noche con Alejamiento y Giros</title>
  <!-- Incluye CesiumJS -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.100/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.100/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body {
      width: 100%; 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      overflow: hidden;
      background: black;
    }
    /* Contenedor del visor */
    #cesiumContainer {
      width: 100%; 
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    /* Overlay para mostrar el nombre de la ciudad (usado en la animación) */
    #cityName {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 24px;
      color: white;
      text-shadow: 1px 1px 3px black;
      z-index: 3;
    }
    /* Overlay para mostrar mensajes (RASTREANDO / OBJETIVO ENCONTRADO) */
    #objectiveFound {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 30px;
      color: yellow;
      text-shadow: 1px 1px 3px black;
      z-index: 3;
      opacity: 0;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
    /* Overlay para el efecto de fade-in al inicio */
    #fadeOverlay {
      position: absolute;
      width: 100%;
      height: 100%;
      background: black;
      z-index: 4;
      opacity: 1;
      transition: opacity 4s ease;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="cityName"></div>
  <div id="objectiveFound">RASTREANDO</div>
  <!-- Overlay de inicio -->
  <div id="fadeOverlay"></div>
  
  <script>
    // Inserta tu token de Cesium Ion aquí:
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiOGNjNjczOS05ODM1LTQ4YjQtOTczNy1lNDliMTg4NzkyNTEiLCJpZCI6Mjc3ODQyLCJpYXQiOjE3NDAwOTgyMzl9.h5RevJ_fpBIjEHlogZOePThDrY3SqygU2FiRkSnXmLM';

    // Inicializar el visor de Cesium
    const viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: new Cesium.IonImageryProvider({ assetId: 2 }),
      baseLayerPicker: false,
      timeline: false,
      animation: false
    });
    viewer.scene.globe.enableLighting = true;

    // ======================
    // UBICACIONES (principalmente EE.UU. y México, y algunas de Perú, Uruguay y Colombia)
    // ======================
    const locations = [
      { lon: -74.0060,   lat: 40.7128,  height: 20, city: "New York, USA",           timeOfDay: "day" },
      { lon: -118.2437,  lat: 34.0522,  height: 20, city: "Los Angeles, USA",        timeOfDay: "day" },
      { lon: -87.6298,   lat: 41.8781,  height: 20, city: "Chicago, USA",            timeOfDay: "afternoon" },
      { lon: -95.3698,   lat: 29.7604,  height: 20, city: "Houston, USA",            timeOfDay: "day" },
      { lon: -80.1918,   lat: 25.7617,  height: 20, city: "Miami, USA",              timeOfDay: "afternoon" },
      { lon: -99.1332,   lat: 19.4326,  height: 20, city: "Ciudad de México, México", timeOfDay: "afternoon" },
      { lon: -103.3496,  lat: 20.6597,  height: 20, city: "Guadalajara, México",     timeOfDay: "day" },
      { lon: -100.3161,  lat: 25.6866,  height: 20, city: "Monterrey, México",       timeOfDay: "day" },
      { lon: -77.0428,   lat: -12.0464, height: 20, city: "Lima, Perú",              timeOfDay: "day" },
      { lon: -56.1645,   lat: -34.9011, height: 20, city: "Montevideo, Uruguay",     timeOfDay: "afternoon" },
      { lon: -74.0721,   lat: 4.7110,   height: 20, city: "Bogotá, Colombia",        timeOfDay: "afternoon" },
      { lon: -122.4194,  lat: 37.7749,  height: 20, city: "San Francisco, USA",      timeOfDay: "day" }
    ];

    // ======================
    // ETIQUETAS EN EL MAPA
    // ======================
    locations.forEach(loc => {
      const partes = loc.city.split(',');
      const pais = partes[partes.length - 1].trim();
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(loc.lon, loc.lat),
        label: {
          text: pais,
          font: '16px sans-serif',
          fillColor: Cesium.Color.CYAN,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2,
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
        }
      });
    });

    const continentes = [
      { lon: -100, lat: 40, name: "América del Norte" },
      { lon: -60,  lat: -15, name: "América del Sur" },
      { lon: -10,  lat: 50,  name: "Europa" },
      { lon: 20,   lat: 0,   name: "África" },
      { lon: 100,  lat: 45,  name: "Asia" },
      { lon: 135,  lat: -25, name: "Oceanía" }
    ];
    continentes.forEach(cont => {
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(cont.lon, cont.lat),
        label: {
          text: cont.name,
          font: '24px sans-serif',
          fillColor: Cesium.Color.ORANGE,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2,
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
        }
      });
    });
    // ======================
    // FIN ETIQUETAS
    // ======================

    // Función para configurar la hora
    function setTimeOfDay(timeOfDay) {
      let isoTime;
      if (timeOfDay === "day") {
        isoTime = "2025-02-20T12:00:00Z";
      } else if (timeOfDay === "afternoon") {
        isoTime = "2025-02-20T17:00:00Z";
      } else if (timeOfDay === "night") {
        isoTime = "2025-02-20T23:00:00Z";
      } else {
        isoTime = "2025-02-20T12:00:00Z";
      }
      viewer.clock.currentTime = Cesium.JulianDate.fromIso8601(isoTime);
    }

    // Parámetros de animación (tiempos aumentados)
    const overviewHeight = 5000000;      // Vista general
    const overviewDuration = 15;         // 20 segundos para vuelo a vista general
    const destinationDuration = 20;      // 20 segundos para descender a la ubicación
    const awayDuration = 20;             // 20 segundos para el alejamiento
    const awayHeightGlobal = 10000000;   // Altura para ver el planeta completo

    // Vuelo a vista general
    function flyToOverview(location, callback) {
      document.getElementById('cityName').innerText = "";
      // Mantenemos "RASTREANDO" desde el inicio
      const objEl = document.getElementById('objectiveFound');
      objEl.innerText = "RASTREANDO";
      objEl.style.opacity = 1;
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(location.lon, location.lat, overviewHeight),
        duration: overviewDuration,
        complete: callback,
        cancel: callback
      });
    }

    // Giro en vista general (5 segundos, efecto 3D)
    function spinAroundOverview(callback) {
      const objEl = document.getElementById('objectiveFound');
      objEl.innerText = "RASTREANDO";
      objEl.style.opacity = 1;
      const start = performance.now();
      const initialHeading = viewer.camera.heading;
      const initialPitch = viewer.camera.pitch;
      const duration = 12000;
      function spin() {
        const elapsed = performance.now() - start;
        let fraction = elapsed / duration;
        if (fraction > 1) fraction = 1;
        const newPitch = initialPitch + 0.1 * Math.sin(fraction * Math.PI);
        viewer.camera.setView({
          orientation: {
            heading: initialHeading + fraction * Cesium.Math.TWO_PI,
            pitch: newPitch,
            roll: viewer.camera.roll
          }
        });
        if (fraction < 1) {
          requestAnimationFrame(spin);
        } else {
          callback();
        }
      }
      requestAnimationFrame(spin);
    }

    // Vuelo a la ubicación destino (descenso)
    function flyToDestination(location, callback) {
      document.getElementById('cityName').innerText = location.city;
      // Mantenemos "RASTREANDO" hasta el momento de detección
      const objEl = document.getElementById('objectiveFound');
      objEl.innerText = "RASTREANDO";
      objEl.style.opacity = 1;
      setTimeOfDay(location.timeOfDay);
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(location.lon, location.lat, location.height + 200),
        duration: destinationDuration,
        complete: callback,
        cancel: callback
      });
    }

    // Función que muestra el marcador rojo y, tras 1 segundo, cambia el mensaje a "OBJETIVO ENCONTRADO" para iniciar el giro en destino
    function showTargetFoundAndSpin(location, callback) {
      // Agrega un marcador rojo en la ubicación detectada
      const marker = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(location.lon, location.lat, 0),
        billboard: {
          image: 'https://img.icons8.com/fluency/48/ff0000/marker.png',
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          scale: 1.0
        }
      });
      // Espera 1 segundo antes de cambiar el mensaje y comenzar el giro
      setTimeout(() => {
        const objEl = document.getElementById('objectiveFound');
        objEl.innerText = "OBJETIVO ENCONTRADO";
        // Luego se inicia el giro en destino (720° en 5 segundos con efecto 3D)
        spinAtDestination(() => {
          callback();
        });
      }, 1000);
    }

    // Giro en destino: 720° (2 rotaciones) en 5 segundos, con efecto 3D (subida y bajada)
    function spinAtDestination(callback) {
      const duration = 5000;
      const start = performance.now();
      const initialHeading = viewer.camera.heading;
      const initialPitch = viewer.camera.pitch;
      function spin() {
        const elapsed = performance.now() - start;
        let fraction = elapsed / duration;
        if (fraction > 1) fraction = 1;
        const newHeading = initialHeading + fraction * (2 * Cesium.Math.TWO_PI);
        const newPitch = initialPitch + 0.1 * Math.sin(fraction * Math.PI);
        viewer.camera.setView({
          orientation: {
            heading: newHeading,
            pitch: newPitch,
            roll: viewer.camera.roll
          }
        });
        if (fraction < 1) {
          requestAnimationFrame(spin);
        } else {
          callback();
        }
      }
      requestAnimationFrame(spin);
    }

    // Alejamiento con zoom global
    function flyAwayAndZoomOut(callback) {
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(0, 0, awayHeightGlobal),
        duration: awayDuration,
        complete: callback,
        cancel: callback
      });
    }

    // Giro tras zoom (5 segundos, 45° con efecto 3D)
    function spinAfterZoom(callback) {
      const duration = 5000;
      const extraAngle = Cesium.Math.toRadians(45);
      const start = performance.now();
      const initialHeading = viewer.camera.heading;
      const initialPitch = viewer.camera.pitch;
      function spin() {
        const elapsed = performance.now() - start;
        let fraction = elapsed / duration;
        if (fraction > 1) fraction = 1;
        const newHeading = initialHeading + fraction * extraAngle;
        const newPitch = initialPitch + 0.05 * Math.sin(fraction * Math.PI);
        viewer.camera.setView({
          orientation: {
            heading: newHeading,
            pitch: newPitch,
            roll: viewer.camera.roll
          }
        });
        if (fraction < 1) {
          requestAnimationFrame(spin);
        } else {
          callback();
        }
      }
      requestAnimationFrame(spin);
    }

    // Orquesta el recorrido entre ubicaciones:
    // Después de volar a la ubicación y realizar el descenso,
    // se muestra el marcador y se espera 1 segundo para cambiar el mensaje y ejecutar el giro.
    // Luego se espera 2 segundos antes de alejar la cámara y continuar.
    function flyThroughLocations(index) {
      if (index >= locations.length) {
        console.log("Recorrido completo");
        return;
      }
      const location = locations[index];
      flyToOverview(location, () => {
        spinAroundOverview(() => {
          flyToDestination(location, () => {
            console.log("Llegamos a " + location.city);
            showTargetFoundAndSpin(location, () => {
              // Espera 2 segundos antes de iniciar el alejamiento
              setTimeout(() => {
                flyAwayAndZoomOut(() => {
                  spinAfterZoom(() => {
                    flyThroughLocations(index + 1);
                  });
                });
              }, 3000);
            });
          });
        });
      });
    }

    // Inicio tras fade-out
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('fadeOverlay').style.opacity = 0;
        setTimeout(() => {
          document.getElementById('fadeOverlay').remove();
          flyThroughLocations(0);
        }, 3000);
      }, 4000);
    });
  </script>
</body>
</html>
